知り合いとメールのやり取りをしていたら、 docomo宛のメールがときどき文字化けする現象に気がついた。 こんな事例はもう定番なのだろうけれど、ネットで調べてもヒットしなかったので 覚書程度に残しておく（auのメール文字化けは有名で、かなりヒットするんだけど）。 試験用のドコモ携帯が手元にあれば、じっくり調べられるのになぁ。 ■文字化け条件 1)iPhoneからメールを送信すること 2)docomoの携帯電話でメールを受信すること 3)絵文字を入れること 4)特定の字を入れること ちなみに今把握している4)の特定の字は、「飲」「棋」「練」の３つ。 飲む［ビールの絵］で送ったのが文字化けして気がついた。 あと「飲」だけでは文字化けしない。「飲む」とか「飲み」のセットで文字化けする。 文字化け例：「飲み［ビールの絵］」→「 ャン」 ドコモの携帯は半角カナが全角表示になるから、もしかしたら本当は「 ャン」は半角かも。 文字化けする漢字の文字コードは以下のとおり。 区 点 JIS SJIS EUC UTF-8 UTF-16 字 16 91 307B 88F9 B0FB E9A3B2 98F2 飲 20 93 347D 8AFB B4FD E6A38B 68CB 棋 46 93 4E7D 97FB CEFD E7B7B4 7DF4 練 そもそもiPhoneってどんな文字コードでメールを送るの？仕様が不明。 公式ではないとこで確認したら、基本的にメールはiso-2022-jpのようだ。 でもマッピングされてない文字、たとえば♥（ハート）を混ぜるとUTF-8になるらしい。 PCにメールを送って試したところ、確かに上記のとおりだった。 あと普通に絵文字をつけた場合、iso-2022-jpのままだった。 一方、docomoの文字コードはShift_JISだ。 となると、docomo側でiso-2022-jpからShift_JISに変換するところが被疑箇所か。 上の3文字の文字コードの「307B：飲」「347D：棋」「4E7D：練」をみてみると、 2バイト目の上位3ビットが1だとNGなんじゃない？ってあたりを付けて 「307A：引」「3379：鎌」で試したけれど、これは文字化けしなかった。 引数、引き数、鎌倉も、という文例で試験をした。 くさいんだけどねー2byte目にエスケープ文字(0x5C)がある影響で文字化けするなんて 有名な話だしさぁ（「表」とかが文字化けする話）。 「訓練とか」が「訓浴ャニか」で文字化けした。 バイト数を合わせるために”ャニ”は半角だと仮定すると、 不思議なことに前後が一致するんだよね。 練と:1001,0111,1111,1011,1000,0010,1100,0110 浴　 :1001,0111,0001,0001 ャ　 :　　　　　　　　　　　　　,1010,1100 ニ　 :　　　　　　　　　　　　　　　　　　　　,1100,0110 「浴」の先頭1バイトと、「ニ」が、「練と」の前後1バイトと一致してる。 真ん中の2バイト（0xFB82)が合うロジックが思いつかないんだけどね。 と、以降は面倒だから細かいこと書かないけれど、いろいろ試した結果、 ビットが少しずつずれてしまう現象が働いている確証を得た。 2バイト目が上位3ビットが1の文字が出てくると、その文字からなぜかズレてしまい、 上手く半角カナ1バイトで帳尻が合うところまで文字が化けてしまうみたい。 すんごいダラダラ書いたけど、明日は友達を無理やり巻き込んで調査します。